#!/usr/bin/env groovy

// build params
//branchToBuildPlugin - extension branch (default master)
//extensionPath - URL to extension repo
//node - node version

def installNPM(){
	def nodeHome = tool 'nodejs-10.15.3'
	env.PATH="${nodeHome}/bin:${env.PATH}"
	sh "node --version; npm --version"
}


timeout(120) {
	node("${node}"){ stage "Build ${extensionPath}"

        def extensionFolder = extensionSource.split("//")[1]

		echo "${extensionFolder}"

		checkout([$class: 'GitSCM',
				  branches: [[name: "${branchToBuildPlugin}"]],
				  doGenerateSubmoduleConfigurations: false,
				  poll: true,
				  extensions: [[$class: 'RelativeTargetDirectory', relativeTargetDir: "${extensionPath}"]],
				  submoduleCfg: [],
				  userRemoteConfigs: [[url: "${extensionSource}"]]])

		installNPM()
		sh "cd ${extensionFolder} && sudo npm install -g vsce && sudo npm install -g gulp && npm install && vsce package"

		archiveArtifacts artifacts: '**/*.vsix', fingerprint: true
	}
}
